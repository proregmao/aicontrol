# 智能设备管理系统数据库设计文档

## 📋 文档信息
- **项目名称**: 智能设备管理系统 (Smart Device Management System)
- **数据库版本**: v1.0
- **设计日期**: 2025-09-15
- **数据库**: PostgreSQL 13+
- **设计师**: AI Assistant (Database Architect)

## 🗄️ 数据库概述

### 数据库配置
```yaml
数据库服务器: 192.168.110.21
数据库名称: smart_device_management
用户名: postgres
密码: abcd1234
端口: 5432
字符集: UTF8
时区: Asia/Shanghai
```

### 数据存储策略
```sql
-- 实时数据存储 (Redis)
实时温度数据: 5秒间隔, TTL 24小时
设备状态缓存: 实时更新, TTL 1小时
用户会话数据: TTL 30分钟

-- 历史数据存储 (PostgreSQL)
原始数据: 保存1周 (temperature_raw_data)
分钟数据: 1分钟平均值, 保存1月 (temperature_minute_data)
小时数据: 1小时平均值, 保存1年 (temperature_hour_data)
日数据: 1天平均值, 保存5年 (temperature_day_data)
```

## 📊 核心数据表设计

### 1. 用户管理表

#### users - 用户基础信息表
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    full_name VARCHAR(100),
    role VARCHAR(20) DEFAULT 'viewer' CHECK (role IN ('viewer', 'operator', 'admin')),
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'locked')),
    last_login_at TIMESTAMP,
    last_login_ip INET,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
```

#### user_sessions - 用户会话表
```sql
CREATE TABLE user_sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    session_token VARCHAR(255) UNIQUE NOT NULL,
    ip_address INET,
    user_agent TEXT,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_user_sessions_token ON user_sessions(session_token);
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_expires ON user_sessions(expires_at);
```

### 2. 设备管理表

#### devices - 设备基础信息表
```sql
CREATE TABLE devices (
    id SERIAL PRIMARY KEY,
    device_type VARCHAR(50) NOT NULL CHECK (device_type IN ('temperature_sensor', 'breaker', 'server')),
    device_name VARCHAR(100) NOT NULL,
    device_model VARCHAR(100),
    ip_address INET,
    port INTEGER,
    slave_id INTEGER,
    location VARCHAR(200),
    description TEXT,
    status VARCHAR(20) DEFAULT 'online' CHECK (status IN ('online', 'offline', 'error', 'maintenance')),
    config JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_devices_type ON devices(device_type);
CREATE INDEX idx_devices_status ON devices(status);
CREATE INDEX idx_devices_ip ON devices(ip_address);
```

#### device_connections - 设备连接配置表
```sql
CREATE TABLE device_connections (
    id SERIAL PRIMARY KEY,
    device_id INTEGER REFERENCES devices(id) ON DELETE CASCADE,
    connection_type VARCHAR(50) NOT NULL CHECK (connection_type IN ('modbus', 'ssh', 'http')),
    host VARCHAR(255) NOT NULL,
    port INTEGER NOT NULL,
    username VARCHAR(100),
    password_encrypted TEXT,
    private_key_path VARCHAR(500),
    timeout_seconds INTEGER DEFAULT 30,
    retry_count INTEGER DEFAULT 3,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_device_connections_device_id ON device_connections(device_id);
CREATE INDEX idx_device_connections_type ON device_connections(connection_type);
```

### 3. 温度监控表

#### temperature_sensors - 温度传感器配置表
```sql
CREATE TABLE temperature_sensors (
    id SERIAL PRIMARY KEY,
    device_id INTEGER REFERENCES devices(id) ON DELETE CASCADE,
    sensor_channel INTEGER NOT NULL, -- 传感器通道 (1-4)
    sensor_name VARCHAR(100) NOT NULL,
    location VARCHAR(200),
    min_threshold DECIMAL(5,2) DEFAULT 0.0,
    max_threshold DECIMAL(5,2) DEFAULT 50.0,
    calibration_offset DECIMAL(5,2) DEFAULT 0.0,
    is_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(device_id, sensor_channel)
);

-- 索引
CREATE INDEX idx_temperature_sensors_device ON temperature_sensors(device_id);
CREATE INDEX idx_temperature_sensors_enabled ON temperature_sensors(is_enabled);
```

#### temperature_raw_data - 温度原始数据表 (分区表)
```sql
CREATE TABLE temperature_raw_data (
    id BIGSERIAL,
    sensor_id INTEGER REFERENCES temperature_sensors(id) ON DELETE CASCADE,
    temperature DECIMAL(5,2) NOT NULL,
    humidity DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- 创建分区表 (按月分区)
CREATE TABLE temperature_raw_data_2025_01 PARTITION OF temperature_raw_data
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- 索引
CREATE INDEX idx_temperature_raw_sensor_time ON temperature_raw_data(sensor_id, created_at);
```

#### temperature_minute_data - 分钟级温度数据表
```sql
CREATE TABLE temperature_minute_data (
    id BIGSERIAL PRIMARY KEY,
    sensor_id INTEGER REFERENCES temperature_sensors(id) ON DELETE CASCADE,
    avg_temperature DECIMAL(5,2) NOT NULL,
    min_temperature DECIMAL(5,2) NOT NULL,
    max_temperature DECIMAL(5,2) NOT NULL,
    avg_humidity DECIMAL(5,2),
    data_points INTEGER DEFAULT 1,
    minute_time TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE UNIQUE INDEX idx_temperature_minute_sensor_time ON temperature_minute_data(sensor_id, minute_time);
CREATE INDEX idx_temperature_minute_time ON temperature_minute_data(minute_time);
```

### 4. 服务器管理表

#### servers - 服务器信息表
```sql
CREATE TABLE servers (
    id SERIAL PRIMARY KEY,
    device_id INTEGER REFERENCES devices(id) ON DELETE CASCADE,
    server_name VARCHAR(100) NOT NULL,
    hostname VARCHAR(255),
    os_type VARCHAR(50),
    os_version VARCHAR(100),
    cpu_cores INTEGER,
    memory_gb INTEGER,
    disk_gb INTEGER,
    is_monitored BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_servers_device_id ON servers(device_id);
CREATE INDEX idx_servers_monitored ON servers(is_monitored);
```

#### server_status_logs - 服务器状态日志表
```sql
CREATE TABLE server_status_logs (
    id BIGSERIAL PRIMARY KEY,
    server_id INTEGER REFERENCES servers(id) ON DELETE CASCADE,
    cpu_usage DECIMAL(5,2),
    memory_usage DECIMAL(5,2),
    disk_usage DECIMAL(5,2),
    network_in_mbps DECIMAL(10,2),
    network_out_mbps DECIMAL(10,2),
    uptime_seconds BIGINT,
    load_average DECIMAL(5,2),
    status VARCHAR(20) CHECK (status IN ('online', 'offline', 'error')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_server_status_server_time ON server_status_logs(server_id, created_at);
CREATE INDEX idx_server_status_time ON server_status_logs(created_at);
```

### 5. 断路器管理表

#### breakers - 断路器信息表
```sql
CREATE TABLE breakers (
    id SERIAL PRIMARY KEY,
    device_id INTEGER REFERENCES devices(id) ON DELETE CASCADE,
    breaker_name VARCHAR(100) NOT NULL,
    rated_voltage DECIMAL(8,2),
    rated_current DECIMAL(8,2),
    location VARCHAR(200),
    is_controllable BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_breakers_device_id ON breakers(device_id);
CREATE INDEX idx_breakers_controllable ON breakers(is_controllable);
```

#### breaker_server_bindings - 断路器服务器绑定表
```sql
CREATE TABLE breaker_server_bindings (
    id SERIAL PRIMARY KEY,
    breaker_id INTEGER REFERENCES breakers(id) ON DELETE CASCADE,
    server_id INTEGER REFERENCES servers(id) ON DELETE CASCADE,
    binding_name VARCHAR(100),
    shutdown_delay_seconds INTEGER DEFAULT 300, -- 关机延迟时间
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(breaker_id, server_id)
);

-- 索引
CREATE INDEX idx_breaker_bindings_breaker ON breaker_server_bindings(breaker_id);
CREATE INDEX idx_breaker_bindings_server ON breaker_server_bindings(server_id);
CREATE INDEX idx_breaker_bindings_active ON breaker_server_bindings(is_active);
```

#### breaker_status_logs - 断路器状态日志表
```sql
CREATE TABLE breaker_status_logs (
    id BIGSERIAL PRIMARY KEY,
    breaker_id INTEGER REFERENCES breakers(id) ON DELETE CASCADE,
    voltage_a DECIMAL(8,2),
    voltage_b DECIMAL(8,2),
    voltage_c DECIMAL(8,2),
    current_a DECIMAL(8,2),
    current_b DECIMAL(8,2),
    current_c DECIMAL(8,2),
    power_kw DECIMAL(10,2),
    power_factor DECIMAL(4,3),
    frequency DECIMAL(6,2),
    switch_status VARCHAR(20) CHECK (switch_status IN ('on', 'off', 'tripped', 'unknown')),
    temperature DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_breaker_status_breaker_time ON breaker_status_logs(breaker_id, created_at);
CREATE INDEX idx_breaker_status_time ON breaker_status_logs(created_at);
```

### 6. 定时任务表

#### scheduled_tasks - 定时任务表
```sql
CREATE TABLE scheduled_tasks (
    id SERIAL PRIMARY KEY,
    task_name VARCHAR(100) NOT NULL,
    task_type VARCHAR(50) NOT NULL CHECK (task_type IN ('breaker_on', 'breaker_off', 'server_shutdown', 'server_reboot')),
    target_id INTEGER NOT NULL, -- 目标设备ID
    cron_expression VARCHAR(100), -- Cron表达式
    execute_at TIMESTAMP, -- 一次性任务执行时间
    is_recurring BOOLEAN DEFAULT false,
    is_enabled BOOLEAN DEFAULT true,
    description TEXT,
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_scheduled_tasks_type ON scheduled_tasks(task_type);
CREATE INDEX idx_scheduled_tasks_enabled ON scheduled_tasks(is_enabled);
CREATE INDEX idx_scheduled_tasks_execute_at ON scheduled_tasks(execute_at);
```

#### task_execution_logs - 任务执行日志表
```sql
CREATE TABLE task_execution_logs (
    id BIGSERIAL PRIMARY KEY,
    task_id INTEGER REFERENCES scheduled_tasks(id) ON DELETE CASCADE,
    execution_status VARCHAR(20) CHECK (execution_status IN ('pending', 'running', 'success', 'failed', 'cancelled')),
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    error_message TEXT,
    execution_details JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_task_execution_task_id ON task_execution_logs(task_id);
CREATE INDEX idx_task_execution_status ON task_execution_logs(execution_status);
CREATE INDEX idx_task_execution_time ON task_execution_logs(created_at);
```

### 7. 告警管理表

#### alarm_rules - 告警规则表
```sql
CREATE TABLE alarm_rules (
    id SERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL,
    alarm_type VARCHAR(50) NOT NULL CHECK (alarm_type IN (
        'temperature_abnormal', 'humidity_abnormal', 'power_abnormal',
        'voltage_abnormal', 'current_abnormal', 'device_abnormal',
        'network_abnormal', 'system_abnormal'
    )),
    target_device_id INTEGER REFERENCES devices(id),
    condition_parameter VARCHAR(100) NOT NULL, -- 监控参数
    condition_operator VARCHAR(10) NOT NULL CHECK (condition_operator IN ('>', '<', '>=', '<=', '==', '!=')),
    threshold_value DECIMAL(10,2) NOT NULL,
    duration_seconds INTEGER DEFAULT 300, -- 持续时间
    alarm_level VARCHAR(20) DEFAULT 'warning' CHECK (alarm_level IN ('info', 'warning', 'critical', 'emergency')),
    is_enabled BOOLEAN DEFAULT true,
    description TEXT,
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_alarm_rules_type ON alarm_rules(alarm_type);
CREATE INDEX idx_alarm_rules_enabled ON alarm_rules(is_enabled);
CREATE INDEX idx_alarm_rules_device ON alarm_rules(target_device_id);
```

#### alarm_notifications - 告警通知配置表
```sql
CREATE TABLE alarm_notifications (
    id SERIAL PRIMARY KEY,
    rule_id INTEGER REFERENCES alarm_rules(id) ON DELETE CASCADE,
    notification_type VARCHAR(50) NOT NULL CHECK (notification_type IN ('system', 'email', 'dingtalk')),
    is_enabled BOOLEAN DEFAULT true,
    config JSONB, -- 通知配置 (邮件地址、钉钉webhook等)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_alarm_notifications_rule ON alarm_notifications(rule_id);
CREATE INDEX idx_alarm_notifications_type ON alarm_notifications(notification_type);
```

#### alarm_logs - 告警日志表
```sql
CREATE TABLE alarm_logs (
    id BIGSERIAL PRIMARY KEY,
    rule_id INTEGER REFERENCES alarm_rules(id),
    alarm_level VARCHAR(20) NOT NULL,
    alarm_message TEXT NOT NULL,
    current_value DECIMAL(10,2),
    threshold_value DECIMAL(10,2),
    device_info JSONB,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'acknowledged', 'resolved', 'suppressed')),
    acknowledged_by INTEGER REFERENCES users(id),
    acknowledged_at TIMESTAMP,
    resolved_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_alarm_logs_rule_id ON alarm_logs(rule_id);
CREATE INDEX idx_alarm_logs_status ON alarm_logs(status);
CREATE INDEX idx_alarm_logs_level ON alarm_logs(alarm_level);
CREATE INDEX idx_alarm_logs_time ON alarm_logs(created_at);
```

### 8. AI智能控制表

#### ai_control_strategies - AI控制策略表
```sql
CREATE TABLE ai_control_strategies (
    id SERIAL PRIMARY KEY,
    strategy_name VARCHAR(100) NOT NULL,
    strategy_type VARCHAR(50) NOT NULL CHECK (strategy_type IN (
        'temperature_control', 'humidity_control', 'power_control',
        'time_control', 'energy_saving', 'safety_protection'
    )),
    trigger_conditions JSONB NOT NULL, -- 触发条件配置
    actions JSONB NOT NULL, -- 执行动作配置
    priority INTEGER DEFAULT 1, -- 策略优先级
    is_enabled BOOLEAN DEFAULT true,
    description TEXT,
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_ai_strategies_type ON ai_control_strategies(strategy_type);
CREATE INDEX idx_ai_strategies_enabled ON ai_control_strategies(is_enabled);
CREATE INDEX idx_ai_strategies_priority ON ai_control_strategies(priority);
```

#### ai_execution_logs - AI执行日志表
```sql
CREATE TABLE ai_execution_logs (
    id BIGSERIAL PRIMARY KEY,
    strategy_id INTEGER REFERENCES ai_control_strategies(id),
    trigger_data JSONB, -- 触发时的数据
    executed_actions JSONB, -- 执行的动作
    execution_result VARCHAR(20) CHECK (execution_result IN ('success', 'failed', 'partial')),
    error_message TEXT,
    execution_time_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_ai_execution_strategy ON ai_execution_logs(strategy_id);
CREATE INDEX idx_ai_execution_result ON ai_execution_logs(execution_result);
CREATE INDEX idx_ai_execution_time ON ai_execution_logs(created_at);
```

### 9. 操作审计表

#### audit_logs - 操作审计日志表
```sql
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    action VARCHAR(100) NOT NULL, -- 操作类型
    resource_type VARCHAR(50) NOT NULL, -- 资源类型
    resource_id INTEGER, -- 资源ID
    old_values JSONB, -- 操作前的值
    new_values JSONB, -- 操作后的值
    ip_address INET,
    user_agent TEXT,
    request_id VARCHAR(100), -- 请求ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_logs_time ON audit_logs(created_at);
```

---

**数据库设计状态**: ✅ 已完成
**审核状态**: 待审核
**下一步**: API接口规范设计
```
