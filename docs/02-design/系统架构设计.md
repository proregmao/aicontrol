# 智能设备管理系统架构设计文档

## 📋 文档信息
- **项目名称**: 智能设备管理系统 (Smart Device Management System)
- **架构版本**: v1.0
- **设计日期**: 2025-09-15
- **架构师**: AI Assistant (System Architect)
- **技术栈**: Go + Vue3 + PostgreSQL + Redis

## 🏗️ 整体架构设计

### 系统架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    智能设备管理系统                          │
├─────────────────────────────────────────────────────────────┤
│                     前端层 (Frontend)                       │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ Vue3 + Element Plus + TypeScript + Vite                │ │
│  │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │ │
│  │ │ 系统概览 │ │ 温度监控 │ │ 服务器  │ │ 断路器  │        │ │
│  │ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │ │
│  │ ┌─────────┐ ┌─────────┐ ┌─────────┐                    │ │
│  │ │AI智能控制│ │ 智能告警 │ │ 安全控制 │                    │ │
│  │ └─────────┘ └─────────┘ └─────────┘                    │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                     网关层 (Gateway)                        │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ Nginx 反向代理 + 负载均衡 + SSL终端                      │ │
│  │ API路由 + 静态资源服务 + WebSocket代理                   │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                     应用层 (Backend)                        │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ Go + Gin + GORM + WebSocket                             │ │
│  │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │ │
│  │ │ 温度服务 │ │ 服务器  │ │ 断路器  │ │ 告警服务 │        │ │
│  │ │ Service │ │ Service │ │ Service │ │ Service │        │ │
│  │ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │ │
│  │ ┌─────────┐ ┌─────────┐ ┌─────────┐                    │ │
│  │ │AI控制   │ │ 安全服务 │ │ 通知服务 │                    │ │
│  │ │ Service │ │ Service │ │ Service │                    │ │
│  │ └─────────┘ └─────────┘ └─────────┘                    │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                     数据层 (Data)                           │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ PostgreSQL (主数据库) + Redis (缓存/实时数据)            │ │
│  │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │ │
│  │ │ 设备数据 │ │ 用户数据 │ │ 配置数据 │ │ 日志数据 │        │ │
│  │ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                     设备层 (Devices)                        │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ RS485-ETH-M04 + RS485-18B20-6H1 + LX47LE-125          │ │
│  │ ┌─────────┐ ┌─────────┐ ┌─────────┐                    │ │
│  │ │ 温度传感器│ │ 智能断路器│ │ 目标服务器│                    │ │
│  │ │ (4路)   │ │ (2个)   │ │ (2台)   │                    │ │
│  │ └─────────┘ └─────────┘ └─────────┘                    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 技术架构选型

### 前端技术栈
```typescript
// 核心框架
Vue3 + Composition API + TypeScript
Element Plus UI组件库
Vite 构建工具
Pinia 状态管理
Vue Router 路由管理

// 开发工具
ESLint + Prettier 代码规范
Husky + lint-staged Git钩子
Vitest 单元测试
Playwright E2E测试
```

### 后端技术栈
```go
// 核心框架
Go 1.21+
Gin Web框架
GORM ORM框架
WebSocket 实时通信

// 数据存储
PostgreSQL 主数据库
Redis 缓存和实时数据
```

### 基础设施
```yaml
# 部署环境
Docker + Docker Compose
Nginx 反向代理
SSL/TLS 加密传输

# 监控告警
Prometheus + Grafana 监控
钉钉机器人通知
```

## 📊 数据流设计

### 实时数据流
```
设备数据采集流程:
温度传感器 → RS485-ETH-M04 → Go后端 → Redis缓存 → WebSocket → Vue前端

断路器控制流程:
Vue前端 → Go后端 → LX47LE-125断路器 → 状态反馈 → Redis → WebSocket → Vue前端

服务器管理流程:
Vue前端 → Go后端 → SSH连接 → 目标服务器 → 执行结果 → Go后端 → Vue前端
```

### 数据存储策略
```sql
-- 实时数据 (Redis)
温度数据: 5秒间隔, TTL 24小时
设备状态: 实时更新, TTL 1小时
用户会话: TTL 30分钟

-- 历史数据 (PostgreSQL)
分钟数据: 1分钟平均值, 保存1周
小时数据: 1小时平均值, 保存1月
日数据: 1天平均值, 保存1年
```

## 🏛️ 模块划分设计

### 后端模块结构
```
backend/
├── cmd/                    # 应用入口
│   └── server/
│       └── main.go
├── internal/               # 内部包
│   ├── api/               # API路由和处理器
│   │   ├── v1/
│   │   │   ├── dashboard/     # 系统概览API
│   │   │   ├── temperature/   # 温度监控API
│   │   │   ├── server/        # 服务器管理API
│   │   │   ├── breaker/       # 断路器控制API
│   │   │   ├── aicontrol/     # AI智能控制API
│   │   │   ├── alarm/         # 智能告警API
│   │   │   └── security/      # 安全控制API
│   │   └── middleware/        # 中间件
│   ├── service/           # 业务逻辑层
│   │   ├── temperature/
│   │   ├── server/
│   │   ├── breaker/
│   │   ├── aicontrol/
│   │   ├── alarm/
│   │   └── security/
│   ├── repository/        # 数据访问层
│   │   ├── postgres/
│   │   └── redis/
│   ├── model/            # 数据模型
│   ├── config/           # 配置管理
│   ├── pkg/              # 工具包
│   │   ├── modbus/       # Modbus通信
│   │   ├── ssh/          # SSH连接
│   │   ├── dingtalk/     # 钉钉通知
│   │   └── websocket/    # WebSocket
│   └── types/            # 类型定义
└── migrations/           # 数据库迁移
```

### 前端模块结构
```
frontend/
├── src/
│   ├── components/           # 公共组件
│   │   ├── common/          # 通用组件
│   │   ├── charts/          # 图表组件
│   │   └── forms/           # 表单组件
│   ├── views/               # 页面组件
│   │   ├── Dashboard/       # 系统概览
│   │   ├── Temperature/     # 温度监控
│   │   ├── Server/          # 服务器管理
│   │   ├── Breaker/         # 断路器控制
│   │   ├── AIControl/       # AI智能控制
│   │   ├── Alarm/           # 智能告警
│   │   └── Security/        # 安全控制
│   ├── stores/              # Pinia状态管理
│   ├── api/                 # API接口
│   ├── types/               # TypeScript类型
│   ├── utils/               # 工具函数
│   ├── composables/         # 组合式函数
│   └── router/              # 路由配置
└── public/                  # 静态资源

## 🔄 通信协议设计

### WebSocket通信
```typescript
// WebSocket消息格式
interface WSMessage {
  type: 'temperature' | 'server' | 'breaker' | 'alarm' | 'heartbeat'
  action: 'update' | 'alert' | 'status' | 'ping'
  data: any
  timestamp: number
}

// 实时数据推送
温度数据推送: 每5秒推送一次最新温度数据
设备状态推送: 状态变化时立即推送
告警推送: 告警触发时立即推送
心跳检测: 每30秒一次心跳包
```

### Modbus通信协议
```go
// Modbus设备通信配置
type ModbusConfig struct {
    Host     string `json:"host"`     // 设备IP地址
    Port     int    `json:"port"`     // 端口号(503/505)
    SlaveID  byte   `json:"slave_id"` // 从站地址
    Timeout  int    `json:"timeout"`  // 超时时间(秒)
}

// 温度传感器读取
func ReadTemperature(config ModbusConfig) ([]float64, error)

// 断路器控制
func ControlBreaker(config ModbusConfig, action string) error
```

### SSH通信协议
```go
// SSH连接配置
type SSHConfig struct {
    Host       string `json:"host"`        // 服务器IP
    Port       int    `json:"port"`        // SSH端口
    Username   string `json:"username"`    // 用户名
    Password   string `json:"password"`    // 密码
    PrivateKey string `json:"private_key"` // 私钥路径
    Timeout    int    `json:"timeout"`     // 超时时间
}

// SSH命令执行
func ExecuteSSHCommand(config SSHConfig, command string) (string, error)
```

## 🔐 安全架构设计

### 认证授权
```go
// JWT Token结构
type JWTClaims struct {
    UserID   uint   `json:"user_id"`
    Username string `json:"username"`
    Role     string `json:"role"`
    jwt.StandardClaims
}

// 权限级别
const (
    RoleViewer = "viewer"   // 只读权限
    RoleOperator = "operator" // 操作权限
    RoleAdmin = "admin"     // 管理员权限
)
```

### 操作审计
```go
// 审计日志结构
type AuditLog struct {
    ID        uint      `json:"id"`
    UserID    uint      `json:"user_id"`
    Action    string    `json:"action"`    // 操作类型
    Resource  string    `json:"resource"`  // 操作资源
    Details   string    `json:"details"`   // 操作详情
    IP        string    `json:"ip"`        // 客户端IP
    UserAgent string    `json:"user_agent"` // 用户代理
    CreatedAt time.Time `json:"created_at"`
}
```

## 📈 性能优化设计

### 缓存策略
```redis
# Redis缓存键设计
temperature:realtime:{sensor_id}    # 实时温度数据
server:status:{server_id}           # 服务器状态
breaker:status:{breaker_id}         # 断路器状态
user:session:{user_id}              # 用户会话
alarm:rules                         # 告警规则缓存
```

### 数据库优化
```sql
-- 索引设计
CREATE INDEX idx_temperature_sensor_time ON temperature_data(sensor_id, created_at);
CREATE INDEX idx_audit_user_time ON audit_logs(user_id, created_at);
CREATE INDEX idx_alarm_status_time ON alarm_logs(status, created_at);

-- 分区表设计
CREATE TABLE temperature_data_2025_01 PARTITION OF temperature_data
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

---

**架构状态**: ✅ 已完成
**审核状态**: 待审核
**下一步**: 数据库设计
```
