# æ™ºèƒ½è®¾å¤‡ç®¡ç†ç³»ç»Ÿ - è¿ç»´æ‰‹å†Œ

## ğŸ“‹ è¿ç»´æ¦‚è¿°

æœ¬æ‰‹å†Œæä¾›æ™ºèƒ½è®¾å¤‡ç®¡ç†ç³»ç»Ÿçš„æ—¥å¸¸è¿ç»´æŒ‡å¯¼ï¼ŒåŒ…æ‹¬ç›‘æ§ã€ç»´æŠ¤ã€æ•…éšœå¤„ç†å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

## ğŸ” ç³»ç»Ÿç›‘æ§

### å…³é”®æŒ‡æ ‡ç›‘æ§

#### ç³»ç»Ÿèµ„æºç›‘æ§
```bash
# CPUä½¿ç”¨ç‡
top -p $(pgrep -f "smart-device-management")

# å†…å­˜ä½¿ç”¨æƒ…å†µ
free -h
ps aux | grep smart-device-management

# ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -h
du -sh /var/log/smart-device-management/

# ç½‘ç»œè¿æ¥
netstat -tulpn | grep :8080
ss -tulpn | grep :8080
```

#### åº”ç”¨ç›‘æ§æŒ‡æ ‡
- **å“åº”æ—¶é—´**: APIå¹³å‡å“åº”æ—¶é—´ < 200ms
- **é”™è¯¯ç‡**: HTTP 5xxé”™è¯¯ç‡ < 1%
- **å¹¶å‘è¿æ¥**: WebSocketå¹¶å‘è¿æ¥æ•°
- **æ•°æ®åº“è¿æ¥**: æ´»è·ƒè¿æ¥æ•° < 80%æœ€å¤§è¿æ¥æ•°
- **å†…å­˜ä½¿ç”¨**: åº”ç”¨å†…å­˜ä½¿ç”¨ < 80%å¯ç”¨å†…å­˜

### ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# monitor.sh - ç³»ç»Ÿç›‘æ§è„šæœ¬

LOG_FILE="/var/log/system-monitor.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service() {
    local service_name=$1
    local port=$2
    
    if curl -f http://localhost:$port/health &>/dev/null; then
        echo "[$DATE] $service_name: OK" >> $LOG_FILE
        return 0
    else
        echo "[$DATE] $service_name: FAILED" >> $LOG_FILE
        return 1
    fi
}

# æ£€æŸ¥åç«¯æœåŠ¡
if ! check_service "Backend" 8080; then
    # å‘é€å‘Šè­¦
    echo "Backend service is down!" | mail -s "Alert: Service Down" admin@company.com
fi

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
if ! pg_isready -h localhost -p 5432 &>/dev/null; then
    echo "[$DATE] Database: FAILED" >> $LOG_FILE
    echo "Database is down!" | mail -s "Alert: Database Down" admin@company.com
else
    echo "[$DATE] Database: OK" >> $LOG_FILE
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "[$DATE] Disk usage: ${DISK_USAGE}% - WARNING" >> $LOG_FILE
    echo "Disk usage is ${DISK_USAGE}%" | mail -s "Alert: High Disk Usage" admin@company.com
fi
```

## ğŸ”§ æ—¥å¸¸ç»´æŠ¤

### æ—¥å¿—ç®¡ç†

#### æ—¥å¿—è½®è½¬é…ç½®
```bash
# /etc/logrotate.d/smart-device-management
/var/log/smart-device-management/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 app app
    postrotate
        systemctl reload smart-device-management
    endscript
}
```

#### æ—¥å¿—åˆ†æ
```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep "ERROR" /var/log/smart-device-management/app.log | tail -100

# åˆ†æAPIå“åº”æ—¶é—´
awk '/API Request/ {print $NF}' /var/log/smart-device-management/app.log | \
    sort -n | awk '{sum+=$1; count++} END {print "Average:", sum/count "ms"}'

# ç»Ÿè®¡é”™è¯¯ç±»å‹
grep "ERROR" /var/log/smart-device-management/app.log | \
    awk '{print $5}' | sort | uniq -c | sort -nr
```

### æ•°æ®åº“ç»´æŠ¤

#### å®šæœŸç»´æŠ¤ä»»åŠ¡
```sql
-- æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
ANALYZE;

-- æ¸…ç†è¿‡æœŸæ•°æ®ï¼ˆä¿ç•™3ä¸ªæœˆï¼‰
DELETE FROM device_logs WHERE created_at < NOW() - INTERVAL '3 months';
DELETE FROM alarm_records WHERE created_at < NOW() - INTERVAL '3 months';

-- é‡å»ºç´¢å¼•
REINDEX DATABASE smart_device_management;

-- æ£€æŸ¥æ•°æ®åº“å¤§å°
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

#### æ•°æ®åº“å¤‡ä»½éªŒè¯
```bash
#!/bin/bash
# verify-backup.sh

BACKUP_FILE="/backup/postgres/backup_$(date +%Y%m%d).sql"
TEST_DB="smart_device_management_test"

# åˆ›å»ºæµ‹è¯•æ•°æ®åº“
createdb $TEST_DB

# æ¢å¤å¤‡ä»½åˆ°æµ‹è¯•æ•°æ®åº“
psql $TEST_DB < $BACKUP_FILE

# éªŒè¯æ•°æ®å®Œæ•´æ€§
TABLES_COUNT=$(psql -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public';" $TEST_DB)

if [ $TABLES_COUNT -gt 0 ]; then
    echo "Backup verification: PASSED ($TABLES_COUNT tables restored)"
else
    echo "Backup verification: FAILED"
    exit 1
fi

# æ¸…ç†æµ‹è¯•æ•°æ®åº“
dropdb $TEST_DB
```

## ğŸš¨ æ•…éšœå¤„ç†

### å¸¸è§æ•…éšœåŠè§£å†³æ–¹æ¡ˆ

#### 1. æœåŠ¡æ— å“åº”
```bash
# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
ps aux | grep smart-device-management

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8080

# é‡å¯æœåŠ¡
systemctl restart smart-device-management

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
journalctl -u smart-device-management -f
```

#### 2. æ•°æ®åº“è¿æ¥æ± è€—å°½
```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥
SELECT 
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    query
FROM pg_stat_activity 
WHERE state = 'active';

-- ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE state = 'active' 
AND query_start < NOW() - INTERVAL '5 minutes';
```

#### 3. å†…å­˜æ³„æ¼
```bash
# ç›‘æ§å†…å­˜ä½¿ç”¨
watch -n 5 'ps aux | grep smart-device-management | grep -v grep'

# ç”Ÿæˆå†…å­˜dumpï¼ˆGoåº”ç”¨ï¼‰
curl http://localhost:8080/debug/pprof/heap > heap.prof

# åˆ†æå†…å­˜ä½¿ç”¨
go tool pprof heap.prof
```

#### 4. WebSocketè¿æ¥å¼‚å¸¸
```bash
# æ£€æŸ¥WebSocketè¿æ¥æ•°
netstat -an | grep :8080 | grep ESTABLISHED | wc -l

# æµ‹è¯•WebSocketè¿æ¥
wscat -c ws://localhost:8080/ws

# æŸ¥çœ‹WebSocketç›¸å…³æ—¥å¿—
grep "websocket" /var/log/smart-device-management/app.log
```

### æ•…éšœå¤„ç†æµç¨‹

```mermaid
graph TD
    A[æ•…éšœå‘ç°] --> B[æ•…éšœç¡®è®¤]
    B --> C[å½±å“è¯„ä¼°]
    C --> D[ç´§æ€¥å¤„ç†]
    D --> E[æ ¹å› åˆ†æ]
    E --> F[æ°¸ä¹…ä¿®å¤]
    F --> G[æ–‡æ¡£æ›´æ–°]
    G --> H[é¢„é˜²æªæ–½]
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–
```sql
-- åˆ†ææ…¢æŸ¥è¯¢
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements 
ORDER BY total_time DESC 
LIMIT 10;

-- åˆ›å»ºå¿…è¦ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_device_logs_created_at 
ON device_logs(created_at);

CREATE INDEX CONCURRENTLY idx_devices_status 
ON devices(status) WHERE status != 'active';
```

#### è¿æ¥æ± ä¼˜åŒ–
```go
// æ•°æ®åº“è¿æ¥æ± é…ç½®
db.SetMaxOpenConns(25)
db.SetMaxIdleConns(5)
db.SetConnMaxLifetime(5 * time.Minute)
```

### åº”ç”¨ä¼˜åŒ–

#### ç¼“å­˜ç­–ç•¥
```go
// Redisç¼“å­˜é…ç½®
type CacheConfig struct {
    DeviceStatusTTL time.Duration // è®¾å¤‡çŠ¶æ€ç¼“å­˜30ç§’
    UserSessionTTL  time.Duration // ç”¨æˆ·ä¼šè¯ç¼“å­˜24å°æ—¶
    APIResponseTTL  time.Duration // APIå“åº”ç¼“å­˜5åˆ†é’Ÿ
}
```

#### WebSocketä¼˜åŒ–
```go
// WebSocketè¿æ¥ä¼˜åŒ–
var upgrader = websocket.Upgrader{
    ReadBufferSize:  1024,
    WriteBufferSize: 1024,
    CheckOrigin: func(r *http.Request) bool {
        return true // ç”Ÿäº§ç¯å¢ƒéœ€è¦ä¸¥æ ¼éªŒè¯
    },
}
```

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### æ»šåŠ¨æ›´æ–°æµç¨‹

```bash
#!/bin/bash
# rolling-update.sh

# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
docker tag current-backend:latest backup-backend:$(date +%Y%m%d)

# 2. æ‹‰å–æ–°ç‰ˆæœ¬
docker pull new-backend:latest

# 3. æ›´æ–°åç«¯æœåŠ¡ï¼ˆé›¶åœæœºï¼‰
docker-compose up -d --no-deps backend

# 4. å¥åº·æ£€æŸ¥
sleep 30
if curl -f http://localhost:8080/health; then
    echo "Backend update successful"
else
    echo "Backend update failed, rolling back..."
    docker-compose up -d --no-deps backup-backend
    exit 1
fi

# 5. æ›´æ–°å‰ç«¯
docker-compose up -d --no-deps frontend
```

### æ•°æ®åº“è¿ç§»

```bash
#!/bin/bash
# migrate-database.sh

# 1. å¤‡ä»½æ•°æ®åº“
pg_dump smart_device_management > backup_before_migration.sql

# 2. æ‰§è¡Œè¿ç§»
./smart-device-management migrate up

# 3. éªŒè¯è¿ç§»
./smart-device-management migrate status
```

## ğŸ“Š æ€§èƒ½åŸºå‡†

### åŸºå‡†æµ‹è¯•

```bash
# APIæ€§èƒ½æµ‹è¯•
ab -n 1000 -c 10 http://localhost:8080/api/v1/devices

# WebSocketè¿æ¥æµ‹è¯•
node websocket-load-test.js --connections 100 --duration 60

# æ•°æ®åº“æ€§èƒ½æµ‹è¯•
pgbench -c 10 -j 2 -t 1000 smart_device_management
```

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ |
|------|--------|----------|
| APIå“åº”æ—¶é—´ | < 200ms | > 500ms |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | < 100ms | > 300ms |
| WebSocketè¿æ¥æ•° | < 1000 | > 1500 |
| CPUä½¿ç”¨ç‡ | < 70% | > 85% |
| å†…å­˜ä½¿ç”¨ç‡ | < 80% | > 90% |
| ç£ç›˜ä½¿ç”¨ç‡ | < 80% | > 90% |

## ğŸ“ åº”æ€¥è”ç³»

### è”ç³»æ–¹å¼
- **æŠ€æœ¯è´Ÿè´£äºº**: tech-lead@company.com
- **è¿ç»´å›¢é˜Ÿ**: ops@company.com
- **24å°æ—¶çƒ­çº¿**: +86-xxx-xxxx-xxxx

### å‡çº§æµç¨‹
1. **P0æ•…éšœ**: ç«‹å³è”ç³»æŠ€æœ¯è´Ÿè´£äºº
2. **P1æ•…éšœ**: 2å°æ—¶å†…è”ç³»ç›¸å…³å›¢é˜Ÿ
3. **P2æ•…éšœ**: å·¥ä½œæ—¶é—´å†…å¤„ç†
4. **P3æ•…éšœ**: è®¡åˆ’ç»´æŠ¤æ—¶é—´å¤„ç†

---

**ğŸ“ æ³¨æ„**: æœ¬æ‰‹å†Œåº”å®šæœŸæ›´æ–°ï¼Œç¡®ä¿ä¸ç³»ç»Ÿå®é™…æƒ…å†µä¿æŒä¸€è‡´ã€‚
