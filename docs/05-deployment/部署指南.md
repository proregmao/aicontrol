# 智能设备管理系统 - 部署指南

## 📋 部署概述

本文档提供智能设备管理系统的完整部署指南，包括开发环境、测试环境和生产环境的部署方案。

## 🏗️ 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Vue3)   │    │   后端 (Go)     │    │ 数据库(PostgreSQL)│
│   Port: 3005    │◄──►│   Port: 8080    │◄──►│   Port: 5432    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Redis缓存     │
                    │   Port: 6379    │
                    └─────────────────┘
```

## 🛠️ 环境要求

### 基础环境
- **操作系统**: Linux (Ubuntu 20.04+ / CentOS 8+)
- **Go**: 1.19+
- **Node.js**: 18+
- **PostgreSQL**: 13+
- **Redis**: 6+
- **Nginx**: 1.18+ (生产环境)

### 硬件要求

#### 开发环境
- CPU: 2核心
- 内存: 4GB
- 存储: 20GB

#### 生产环境
- CPU: 4核心+
- 内存: 8GB+
- 存储: 100GB+

## 🚀 快速部署

### 1. 开发环境部署

```bash
# 1. 克隆项目
git clone <repository-url>
cd smart-device-management

# 2. 后端部署
cd backend
cp configs/.env.example configs/.env
# 编辑 configs/.env 配置数据库连接
go mod tidy
go build -o bin/server cmd/server/main.go

# 3. 前端部署
cd ../frontend
npm install
npm run dev

# 4. 启动服务
# 后端
cd ../backend && ./bin/server

# 前端已在开发模式运行
```

### 2. 生产环境部署

#### 使用Docker Compose (推荐)

```bash
# 1. 创建生产环境配置
cp docker-compose.prod.yml docker-compose.yml

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 3. 启动服务
docker-compose up -d

# 4. 检查服务状态
docker-compose ps
```

## 🐳 Docker部署

### Dockerfile配置

#### 后端Dockerfile
```dockerfile
FROM golang:1.19-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN go build -o server cmd/server/main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/server .
COPY --from=builder /app/configs ./configs
CMD ["./server"]
```

#### 前端Dockerfile
```dockerfile
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### Docker Compose配置

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: smart_device_management
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=smart_device_management
      - DB_USER=postgres
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - redis

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  postgres_data:
```

## ⚙️ 配置管理

### 环境变量配置

```bash
# .env 文件示例
# 应用配置
APP_ENV=production
APP_HOST=0.0.0.0
APP_PORT=8080

# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=smart_device_management
DB_USER=postgres
DB_PASSWORD=your_secure_password

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置
JWT_SECRET=your_super_secret_jwt_key
JWT_EXPIRE_HOURS=24

# 日志配置
LOG_LEVEL=info
LOG_FILE=/var/log/smart-device-management.log
```

### Nginx配置

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api/ {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket代理
    location /ws {
        proxy_pass http://backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 🔒 安全配置

### SSL/TLS配置

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/ssl/certs/your-domain.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.key;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    
    # 其他配置...
}
```

### 防火墙配置

```bash
# Ubuntu/Debian
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

## 📊 监控配置

### 系统监控

```bash
# 安装监控工具
sudo apt install htop iotop nethogs

# 设置日志轮转
sudo nano /etc/logrotate.d/smart-device-management
```

### 应用监控

```yaml
# docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
```

## 🔄 备份策略

### 数据库备份

```bash
#!/bin/bash
# backup-db.sh

DB_NAME="smart_device_management"
BACKUP_DIR="/backup/postgres"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份
pg_dump -h localhost -U postgres $DB_NAME > $BACKUP_DIR/backup_$DATE.sql

# 保留最近7天的备份
find $BACKUP_DIR -name "backup_*.sql" -mtime +7 -delete
```

### 自动备份配置

```bash
# 添加到crontab
0 2 * * * /path/to/backup-db.sh
```

## 🚨 故障排除

### 常见问题

1. **数据库连接失败**
   ```bash
   # 检查数据库状态
   sudo systemctl status postgresql
   
   # 检查连接
   psql -h localhost -U postgres -d smart_device_management
   ```

2. **前端无法访问后端API**
   ```bash
   # 检查后端服务
   curl http://localhost:8080/health
   
   # 检查防火墙
   sudo ufw status
   ```

3. **WebSocket连接失败**
   ```bash
   # 检查WebSocket端点
   wscat -c ws://localhost:8080/ws
   ```

## 📝 部署检查清单

### 部署前检查
- [ ] 环境变量配置正确
- [ ] 数据库连接测试通过
- [ ] SSL证书配置完成
- [ ] 防火墙规则设置
- [ ] 备份策略配置

### 部署后验证
- [ ] 前端页面正常访问
- [ ] API接口响应正常
- [ ] WebSocket连接正常
- [ ] 数据库读写正常
- [ ] 日志记录正常
- [ ] 监控指标正常

## 🔧 维护命令

```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
docker-compose logs -f frontend

# 重启服务
docker-compose restart backend

# 更新服务
docker-compose pull
docker-compose up -d

# 数据库迁移
docker-compose exec backend ./server migrate

# 清理无用镜像
docker system prune -f
```

---

**📞 技术支持**: 如遇部署问题，请参考故障排除章节或联系技术支持团队。
