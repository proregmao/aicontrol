# RS485-ETH-M04 MODBUS 协议转换器使用说明

> **设备型号**: RS485-ETH-M04
> **文档来源**: 基于RS485.pdf及技术文档整理
> **最后更新**: 2025年1月

## 概述

RS485-ETH-M04是一款专业的MODBUS协议转换器，支持RS485与以太网TCP/IP的双向数据透传及MODBUS协议转换。设备提供8种工作模式，适用于工业自动化、PLC控制、楼宇自控、门禁考勤、电力监控等应用场景。

### 核心特性
- **8种工作模式**: 支持多种MODBUS转换和透传模式
- **多端口监听**: 同时监听多个TCP端口（502-505, 5502, 8801-8804）
- **高性能**: 1024字节缓冲区，10/100Mbps以太网
- **易配置**: Web界面配置，支持远程管理
- **稳定可靠**: 自动重连、异常恢复机制

## 8种工作模式详解

### 1. MODBUS TCP → MODBUS RTU 通用模式
- **端口**: 502-505
- **功能**: TCP Client ↔ RTU 从站
- **特点**: TCP报文站号直接映射为RTU从站站号
- **应用**: 标准MODBUS TCP到RTU转换

### 2. MODBUS TCP → MODBUS RTU 主站模式
- **端口**: 5502（仅HC0支持）
- **功能**: 内置RTU主站功能，自动轮询1-6号从站
- **特点**: TCP Client可一次性访问多个从站寄存器
- **应用**: 集中式数据采集

### 3. MODBUS RTU → MODBUS TCP 模式
- **端口**: 自定义（默认502）
- **功能**: RTU主站 ↔ TCP Server
- **特点**: 串口报文转换为TCP报文上传
- **应用**: RTU设备数据上传到云平台

### 4. Server透传模式
- **端口**: 8801-8804
- **功能**: 模块作为TCP Server，串口数据 ↔ TCP Client数据
- **特点**: 单纯透传，无协议转换
- **应用**: 传统串口设备网络化

### 5. 普通Client透传模式
- **端口**: 自定义（默认502）
- **功能**: 模块作为TCP Client，串口数据 ↔ TCP Server数据
- **特点**: 主动连接远程服务器
- **应用**: 设备数据主动上传

### 6. 自定义Client透传模式
- **端口**: 自定义
- **功能**: 同普通Client透传
- **特点**: 支持自定义报文头/尾（≤4字节）、心跳包（≤50字节，60s周期）
- **应用**: 特殊协议适配

### 7. AIOT透传模式
- **端口**: 6666（远端）
- **功能**: 连接艾莫迅云服务器（39.108.191.197:6666）
- **特点**: 提供远程虚拟串口功能
- **应用**: 云端设备管理

### 8. MODBUS TCP → MODBUS RTU 高级模式
- **端口**: 502-505
- **功能**: 自动根据寄存器地址计算从站号
- **特点**: 适用于TCP Client不能改站号的场景（如WINCC）
- **应用**: 复杂SCADA系统集成

## 设备配置

### 1. 默认参数
- **默认IP地址**: 192.168.1.12
- **默认登录**: 用户名/密码 = amx666
- **串口默认参数**: 9600, 8数据位, 无校验, 1停止位
- **支持波特率**: 1200 ~ 115200
- **缓冲区大小**: 1024字节

### 2. 网络配置

#### 2.1 端口分配表
| 模式 | TCP端口 | 网口角色 | 串口角色 | 备注 |
|------|---------|----------|----------|------|
| MODBUS TCP→RTU 通用 | 502~505 | TCP Server | RTU从站 | 站号映射=RTU从站号 |
| MODBUS TCP→RTU 主站 | 5502 | TCP Server | RTU从站 | 仅HC0支持，自动轮询1~6号 |
| MODBUS RTU→TCP | 自定义(默认502) | TCP Client | RTU主站 | 模块主动连接远端Server |
| Server透传 | 8801~8804 | TCP Server | RS485设备 | 单纯透传 |
| 普通Client透传 | 自定义(默认502) | TCP Client | RS485设备 | 主动连接TCP Server |
| 自定义Client透传 | 自定义 | TCP Client | RS485设备 | 支持报文头/尾+心跳包 |
| AIOT透传 | 6666(远端) | TCP Client | RS485设备 | 连接艾莫迅云 |
| MODBUS TCP→RTU 高级 | 502~505 | TCP Server | RTU从站 | 自动计算站号 |

#### 2.2 配置方式
1. **Web界面配置**
   - 浏览器访问设备IP地址
   - 输入用户名/密码：amx666
   - 配置IP、串口模式、远程服务器地址等
   - 点击"保存并重启"生效

2. **模式配置页**
   - 串口参数：波特率、数据位、校验位、停止位
   - 串口模式：选择8种模式之一
   - 远程服务器：用于TCP Client/RTU→TCP模式
   - Modbus主站寄存器数量：配置1~6号从站寄存器数

3. **IOT参数页**（自定义Client透传）
   - 设置固定IP
   - 配置心跳包（16进制字符串）
   - 配置报文头/尾（16进制字符串）

### 3. 串口配置

#### 3.1 RS485参数
- **波特率**：1200, 2400, 4800, 9600, 19200, 38400, 57600, 115200 bps
- **数据位**：7, 8 位
- **停止位**：1, 2 位
- **校验位**：无校验(None), 奇校验(Odd), 偶校验(Even)
- **流控制**：无流控制（RS485不需要）

#### 3.2 MODBUS RTU参数
- **从站地址**：1-247（0为广播地址）
- **响应超时**：100ms - 10000ms（可配置）
- **重试次数**：0-10次（可配置）
- **帧间隔**：3.5个字符时间（自动计算）
- **字节间隔**：1.5个字符时间（自动计算）

#### 3.3 RS485接线说明
- **A+（Data+）**：RS485正极数据线
- **B-（Data-）**：RS485负极数据线
- **GND**：信号地线（可选）
- **终端电阻**：120Ω（网络两端需要）

## 报文格式与转换逻辑

### 1. MODBUS TCP报文格式
```
+----------------+----------------+---------------+---------------+----------------+----------------+
| Transaction ID | Protocol ID(0) | Length (2B)   | Unit ID (1B)  | Function Code  | Data           |
+----------------+----------------+---------------+---------------+----------------+----------------+
```
- **Unit ID**: RTU从站地址（通用模式直接映射；主站/高级模式自动计算）

### 2. MODBUS RTU报文格式
```
+--------------+----------------+----------------+---------------+
| Slave Addr   | Function Code  | Data           | CRC16 (2B)    |
+--------------+----------------+----------------+---------------+
```

### 3. 转换示例

#### 3.1 MODBUS TCP → RTU 通用模式
**输入（TCP Client → 模块）：**
```
00 01 00 00 00 06 01 03 00 00 00 0A
```
解释：Transaction=0x0001, 协议=0, 长度=6, 单元ID=1, 功能码=03, 起始寄存器=0, 数量=10

**输出（模块 → RTU从站）：**
```
01 03 00 00 00 0A C5 CD
```
（CRC16自动计算）

#### 3.2 MODBUS RTU → TCP模式
**输入（RTU主站 → 模块）：**
```
01 03 00 00 00 0A C5 CD
```

**输出（模块 → TCP Server）：**
```
00 01 00 00 00 06 01 03 00 00 00 0A
```

#### 3.3 自定义Client透传示例
**输入串口数据：**
```
41 42 43 44   ; (数据 "ABCD")
```

**模块加报文头/尾（如 #### = 23 23 23 23）：**
```
23 23 23 23 41 42 43 44 23 23 23 23
```

**心跳包配置示例：**
- 配置内容：www.amsamotion.com
- 16进制表示：7777772E616D73616D6F74696F6E2E636F6D
- 发送周期：每60秒自动发送

## 设备操作与维护

### 1. 设备重置
- **软件重置**: 通过Web界面重启设备
- **硬件重置**: 上电30秒内长按Reset按钮
- **恢复出厂设置**: 长按Reset后恢复默认参数
  - IP地址：192.168.1.12
  - 用户名/密码：amx666
  - 串口参数：9600, 8N1

### 2. 状态指示
- **电源指示灯**: 设备供电状态
- **网络指示灯**: 以太网连接状态
- **串口指示灯**: RS485通信状态
- **数据指示灯**: 数据传输状态

### 3. 错误处理与恢复
- **连接异常**: 自动重连（Client模式）
- **报文异常**: 丢弃无效数据
- **通信超时**: 自动重试机制
- **缓冲区溢出**: 自动清空并重新开始

## 故障排除

### 5.1 常见问题

#### 网络连接问题
- 检查网线连接
- 验证IP地址配置
- 检查网络防火墙设置

#### 串口通信问题
- 检查RS485接线
- 验证波特率等串口参数
- 检查设备地址配置

#### 协议转换问题
- 验证MODBUS功能码支持
- 检查数据地址映射
- 确认超时参数设置

### 5.2 诊断工具
- 内置诊断功能
- 日志查看
- 网络抓包分析

## 技术规格

### 硬件规格
- **工作电压**: DC 9-36V 或 AC 85-265V（根据型号）
- **功耗**: ≤ 5W
- **工作温度**: -40°C ~ +85°C
- **存储温度**: -40°C ~ +85°C
- **相对湿度**: 5% ~ 95%（无凝露）
- **外壳防护**: IP30
- **安装方式**: DIN导轨安装或壁挂安装

### 通信接口
- **以太网接口**:
  - RJ45接口 × 1
  - 10/100Mbps自适应
  - 支持Auto MDI/MDIX
- **串口接口**:
  - RS485接口 × 1-4（根据型号）
  - 3线制或2线制
  - 隔离电压：2500V

### 协议支持
- **MODBUS TCP**: 完全兼容MODBUS TCP协议
- **MODBUS RTU**: 完全兼容MODBUS RTU协议
- **功能码支持**: 01, 02, 03, 04, 05, 06, 15, 16等常用功能码
- **数据格式**: 支持各种数据类型转换

### 性能指标
- **转换速度**: ≤ 10ms
- **并发连接**: 最多10个TCP连接
- **RTU设备**: 最多247个从站设备
- **数据缓存**: 64KB
- **配置存储**: EEPROM非易失性存储

## 注意事项

1. 设备上电前请确认接线正确
2. 配置参数时请确保网络连接稳定
3. 修改网络参数后需要重启设备
4. 定期备份设备配置参数
5. 在工业环境中使用时注意电磁干扰防护

## 快速配置指南

### 步骤1：硬件连接
1. 连接电源线到设备电源接口
2. 连接以太网线到RJ45接口
3. 连接RS485设备到A+、B-端子
4. 确认所有连接牢固，检查终端电阻

### 步骤2：网络配置
1. 浏览器访问默认IP：192.168.1.12
2. 登录：用户名/密码 = amx666
3. 配置设备IP地址、子网掩码、网关
4. 选择工作模式（8种模式之一）
5. 保存配置并重启设备

### 步骤3：串口配置
1. 设置RS485通信参数
   - 波特率：1200-115200（默认9600）
   - 数据位：8位
   - 校验位：无校验
   - 停止位：1位
2. 配置MODBUS RTU参数（从站地址、超时等）
3. 测试RS485通信是否正常

### 步骤4：模式配置
1. **MODBUS转换模式**：配置端口映射和站号
2. **透传模式**：设置远程服务器地址和端口
3. **自定义模式**：配置报文头尾和心跳包
4. **主站模式**：设置从站寄存器数量

### 步骤5：功能测试
1. 使用MODBUS测试工具验证TCP连接
2. 测试RTU设备通信
3. 验证数据转换功能
4. 检查设备状态指示灯
5. 测试异常恢复机制

## 常用MODBUS功能码说明

| 功能码 | 名称 | 描述 |
|--------|------|------|
| 01 | Read Coils | 读取线圈状态 |
| 02 | Read Discrete Inputs | 读取离散输入状态 |
| 03 | Read Holding Registers | 读取保持寄存器 |
| 04 | Read Input Registers | 读取输入寄存器 |
| 05 | Write Single Coil | 写单个线圈 |
| 06 | Write Single Register | 写单个寄存器 |
| 15 | Write Multiple Coils | 写多个线圈 |
| 16 | Write Multiple Registers | 写多个寄存器 |

## 开发参考

### 1. 代码实现要点
- **TCP层**: 实现多端口监听（502, 503, 504, 505, 8801~8804, 5502）
- **报文解析层**: 识别TCP/RTU格式并转换
- **心跳机制**: 自定义Client模式下，固定60秒发送心跳
- **寄存器映射**: 在主站/高级模式下，需维护站号与寄存器偏移表

### 2. Python代码框架示例
```python
import socket
import struct
import threading
import serial
import time

CONFIG = {
    "ip": "192.168.1.12",
    "tcp_ports": [502, 503, 504, 505, 5502, 8801, 8802, 8803, 8804],
    "serial_ports": {"ch0": "/dev/ttyUSB0"},
    "baudrate": 9600,
    "mode": "MODBUS_TCP_TO_RTU_COMMON"
}

def calc_crc(data: bytes) -> bytes:
    """计算 MODBUS RTU CRC16"""
    crc = 0xFFFF
    for ch in data:
        crc ^= ch
        for _ in range(8):
            if crc & 1:
                crc >>= 1
                crc ^= 0xA001
            else:
                crc >>= 1
    return struct.pack("<H", crc)

def tcp_to_rtu(tcp_data: bytes) -> bytes:
    """TCP 报文 → RTU 报文"""
    if len(tcp_data) < 8:
        return b""
    unit_id = tcp_data[6]
    pdu = tcp_data[7:]
    rtu_data = bytes([unit_id]) + pdu + calc_crc(bytes([unit_id]) + pdu)
    return rtu_data
```

### 3. 应用场景
- **工业自动化**: PLC控制、SCADA系统集成
- **楼宇自控**: 暖通空调、照明控制
- **电力监控**: 电能表、保护装置数据采集
- **门禁考勤**: 传统设备网络化改造

## 联系支持

如需技术支持，请联系：
- 技术支持邮箱：support@amsamotion.com
- 官方网站：www.amsamotion.com
- 云服务器：39.108.191.197:6666（AIOT模式）
- 在线文档：查看完整的RS485.pdf文档

---

**文档说明**:
- 本文档基于RS485-ETH-M04技术文档整理
- 包含完整的8种工作模式和配置方法
- 提供了详细的报文格式和转换示例
- 适用于开发人员和系统集成商参考
- 文档最后更新：2025年1月
