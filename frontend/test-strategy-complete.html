<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½æ§åˆ¶ç­–ç•¥å®Œæ•´åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            background: #f8fafc;
        }
        
        .test-section h2 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #fff;
            border-left: 4px solid #3498db;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success {
            border-left-color: #27ae60;
            background: #d5f4e6;
        }
        
        .error {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        
        .status-enabled {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .status-disabled {
            background: #fdf2f2;
            color: #e74c3c;
        }
        
        .strategy-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .strategy-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .strategy-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .strategy-actions {
            display: flex;
            gap: 10px;
        }
        
        .execution-record {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .execution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .execution-id {
            font-weight: bold;
            color: #495057;
        }
        
        .execution-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-running {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIæ™ºèƒ½æ§åˆ¶ç­–ç•¥å®Œæ•´åŠŸèƒ½æµ‹è¯•</h1>
            <p>æµ‹è¯•ç­–ç•¥çš„åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ã€æ‰§è¡Œç­‰æ‰€æœ‰åŠŸèƒ½</p>
        </div>
        
        <div class="content">
            <!-- ç™»å½•æµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ” ç”¨æˆ·è®¤è¯æµ‹è¯•</h2>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="testLogin()">ç™»å½•æµ‹è¯•</button>
                    <button class="btn btn-warning" onclick="checkToken()">æ£€æŸ¥Token</button>
                </div>
                <div id="auth-result" class="result"></div>
            </div>
            
            <!-- ç­–ç•¥ç®¡ç†æµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ“‹ ç­–ç•¥ç®¡ç†æµ‹è¯•</h2>
                <div class="button-group">
                    <button class="btn btn-success" onclick="loadStrategies()">åŠ è½½ç­–ç•¥åˆ—è¡¨</button>
                    <button class="btn btn-primary" onclick="createTestStrategy()">åˆ›å»ºæµ‹è¯•ç­–ç•¥</button>
                    <button class="btn btn-warning" onclick="editStrategy()">ç¼–è¾‘ç­–ç•¥</button>
                    <button class="btn btn-danger" onclick="deleteStrategy()">åˆ é™¤ç­–ç•¥</button>
                </div>
                <div id="strategy-result" class="result"></div>
                <div id="strategy-list"></div>
            </div>
            
            <!-- ç­–ç•¥æ‰§è¡Œæµ‹è¯• -->
            <div class="test-section">
                <h2>âš¡ ç­–ç•¥æ‰§è¡Œæµ‹è¯•</h2>
                <div class="button-group">
                    <button class="btn btn-success" onclick="executeStrategy()">æ‰§è¡Œç­–ç•¥æµ‹è¯•</button>
                    <button class="btn btn-primary" onclick="loadExecutions()">æŸ¥çœ‹æ‰§è¡Œè®°å½•</button>
                </div>
                <div id="execution-result" class="result"></div>
                <div id="execution-list"></div>
            </div>
            
            <!-- å‰ç«¯é›†æˆæµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸŒ å‰ç«¯é›†æˆæµ‹è¯•</h2>
                <div class="button-group">
                    <a href="http://localhost:3005/ai-control" target="_blank" class="btn btn-primary">æ‰“å¼€å‰ç«¯é¡µé¢</a>
                    <button class="btn btn-success" onclick="testFrontendAPI()">æµ‹è¯•å‰ç«¯APIè°ƒç”¨</button>
                </div>
                <div id="frontend-result" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        let authToken = '';
        let strategies = [];
        let executions = [];
        
        // ç™»å½•æµ‹è¯•
        async function testLogin() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.textContent = 'æ­£åœ¨ç™»å½•...';
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    authToken = result.data.token;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `ç™»å½•æˆåŠŸï¼\nToken: ${authToken.substring(0, 50)}...\nç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(result.data.user, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `ç™»å½•å¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `ç™»å½•é”™è¯¯: ${error.message}`;
            }
        }
        
        // æ£€æŸ¥Token
        function checkToken() {
            const resultDiv = document.getElementById('auth-result');
            if (authToken) {
                resultDiv.className = 'result success';
                resultDiv.textContent = `å½“å‰Token: ${authToken.substring(0, 50)}...`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'æœªç™»å½•ï¼Œè¯·å…ˆæ‰§è¡Œç™»å½•æµ‹è¯•';
            }
        }
        
        // åŠ è½½ç­–ç•¥åˆ—è¡¨
        async function loadStrategies() {
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            const resultDiv = document.getElementById('strategy-result');
            const listDiv = document.getElementById('strategy-list');
            resultDiv.textContent = 'æ­£åœ¨åŠ è½½ç­–ç•¥åˆ—è¡¨...';
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/ai-control/strategies', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    strategies = result.data || [];
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `åŠ è½½æˆåŠŸï¼å…±æ‰¾åˆ° ${strategies.length} ä¸ªç­–ç•¥`;
                    
                    // æ˜¾ç¤ºç­–ç•¥åˆ—è¡¨
                    listDiv.innerHTML = strategies.map(strategy => `
                        <div class="strategy-card">
                            <div class="strategy-header">
                                <div class="strategy-title">${strategy.name}</div>
                                <div>
                                    <span class="status-badge ${strategy.status === 'å¯ç”¨' ? 'status-enabled' : 'status-disabled'}">
                                        ${strategy.status}
                                    </span>
                                    <span class="status-badge">${strategy.priority}</span>
                                </div>
                            </div>
                            <p>${strategy.description}</p>
                            <div class="strategy-actions">
                                <button class="btn btn-success" onclick="executeStrategyById(${strategy.id})">æµ‹è¯•æ‰§è¡Œ</button>
                                <button class="btn btn-warning" onclick="editStrategyById(${strategy.id})">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteStrategyById(${strategy.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `åŠ è½½å¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `åŠ è½½é”™è¯¯: ${error.message}`;
            }
        }
        
        // åˆ›å»ºæµ‹è¯•ç­–ç•¥
        async function createTestStrategy() {
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            const resultDiv = document.getElementById('strategy-result');
            resultDiv.textContent = 'æ­£åœ¨åˆ›å»ºæµ‹è¯•ç­–ç•¥...';
            
            const testStrategy = {
                name: `æµ‹è¯•ç­–ç•¥_${Date.now()}`,
                description: 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºçš„æµ‹è¯•ç­–ç•¥',
                conditions: [
                    {
                        type: 'temperature',
                        device_id: 'temp_001',
                        operator: '>',
                        value: 30,
                        description: 'æ¸©åº¦è¶…è¿‡30åº¦'
                    }
                ],
                actions: [
                    {
                        type: 'breaker_control',
                        device_id: 'breaker_001',
                        device_name: 'æµ‹è¯•æ–­è·¯å™¨',
                        operation: 'off',
                        delay_second: 0,
                        description: 'å…³é—­æµ‹è¯•æ–­è·¯å™¨'
                    }
                ],
                status: 'å¯ç”¨',
                priority: 'é«˜'
            };
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/ai-control/strategies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(testStrategy)
                });
                
                const result = await response.json();
                
                if (result.code === 201) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `ç­–ç•¥åˆ›å»ºæˆåŠŸï¼\nç­–ç•¥ID: ${result.data.id}\nç­–ç•¥åç§°: ${result.data.name}`;
                    // é‡æ–°åŠ è½½ç­–ç•¥åˆ—è¡¨
                    loadStrategies();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `åˆ›å»ºå¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `åˆ›å»ºé”™è¯¯: ${error.message}`;
            }
        }
        
        // æ‰§è¡Œç­–ç•¥æµ‹è¯•
        async function executeStrategy() {
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            if (strategies.length === 0) {
                alert('è¯·å…ˆåŠ è½½ç­–ç•¥åˆ—è¡¨');
                return;
            }
            
            // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„ç­–ç•¥è¿›è¡Œæµ‹è¯•
            const enabledStrategy = strategies.find(s => s.status === 'å¯ç”¨');
            if (!enabledStrategy) {
                alert('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ç­–ç•¥');
                return;
            }
            
            await executeStrategyById(enabledStrategy.id);
        }
        
        // æ ¹æ®IDæ‰§è¡Œç­–ç•¥
        async function executeStrategyById(strategyId) {
            const resultDiv = document.getElementById('execution-result');
            resultDiv.textContent = `æ­£åœ¨æ‰§è¡Œç­–ç•¥ ${strategyId}...`;
            
            try {
                const response = await fetch(`http://localhost:8080/api/v1/ai-control/strategies/${strategyId}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `ç­–ç•¥æ‰§è¡ŒæˆåŠŸï¼\næ‰§è¡ŒID: ${result.data.id}\næ‰§è¡ŒçŠ¶æ€: ${result.data.status}\næ‰§è¡Œç»“æœ: ${result.data.result}`;
                    // é‡æ–°åŠ è½½æ‰§è¡Œè®°å½•
                    loadExecutions();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `æ‰§è¡Œå¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `æ‰§è¡Œé”™è¯¯: ${error.message}`;
            }
        }
        
        // åŠ è½½æ‰§è¡Œè®°å½•
        async function loadExecutions() {
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            const resultDiv = document.getElementById('execution-result');
            const listDiv = document.getElementById('execution-list');
            resultDiv.textContent = 'æ­£åœ¨åŠ è½½æ‰§è¡Œè®°å½•...';
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/ai-control/executions', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    executions = result.data || [];
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `åŠ è½½æˆåŠŸï¼å…±æ‰¾åˆ° ${executions.length} æ¡æ‰§è¡Œè®°å½•`;
                    
                    // æ˜¾ç¤ºæ‰§è¡Œè®°å½•åˆ—è¡¨
                    listDiv.innerHTML = executions.map(execution => `
                        <div class="execution-record">
                            <div class="execution-header">
                                <div class="execution-id">æ‰§è¡ŒID: ${execution.id}</div>
                                <div class="execution-status status-${execution.status}">${execution.status}</div>
                            </div>
                            <p><strong>ç­–ç•¥ID:</strong> ${execution.strategy_id}</p>
                            <p><strong>è§¦å‘æ–¹å¼:</strong> ${execution.trigger_by}</p>
                            <p><strong>æ‰§è¡Œç»“æœ:</strong> ${execution.result}</p>
                            <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(execution.created_at).toLocaleString()}</p>
                        </div>
                    `).join('');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `åŠ è½½å¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `åŠ è½½é”™è¯¯: ${error.message}`;
            }
        }
        
        // ç¼–è¾‘ç­–ç•¥
        function editStrategy() {
            alert('ç¼–è¾‘åŠŸèƒ½è¯·åœ¨ç­–ç•¥åˆ—è¡¨ä¸­ç‚¹å‡»å…·ä½“ç­–ç•¥çš„ç¼–è¾‘æŒ‰é’®');
        }
        
        // æ ¹æ®IDç¼–è¾‘ç­–ç•¥
        async function editStrategyById(strategyId) {
            const strategy = strategies.find(s => s.id === strategyId);
            if (!strategy) {
                alert('ç­–ç•¥ä¸å­˜åœ¨');
                return;
            }
            
            const newName = prompt('è¯·è¾“å…¥æ–°çš„ç­–ç•¥åç§°:', strategy.name);
            if (!newName) return;
            
            const newDescription = prompt('è¯·è¾“å…¥æ–°çš„ç­–ç•¥æè¿°:', strategy.description);
            if (!newDescription) return;
            
            const resultDiv = document.getElementById('strategy-result');
            resultDiv.textContent = `æ­£åœ¨æ›´æ–°ç­–ç•¥ ${strategyId}...`;
            
            try {
                const response = await fetch(`http://localhost:8080/api/v1/ai-control/strategies/${strategyId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name: newName,
                        description: newDescription,
                        status: strategy.status,
                        priority: strategy.priority
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `ç­–ç•¥æ›´æ–°æˆåŠŸï¼\nç­–ç•¥ID: ${result.data.id}\næ–°åç§°: ${result.data.name}`;
                    // é‡æ–°åŠ è½½ç­–ç•¥åˆ—è¡¨
                    loadStrategies();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `æ›´æ–°å¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `æ›´æ–°é”™è¯¯: ${error.message}`;
            }
        }
        
        // åˆ é™¤ç­–ç•¥
        function deleteStrategy() {
            alert('åˆ é™¤åŠŸèƒ½è¯·åœ¨ç­–ç•¥åˆ—è¡¨ä¸­ç‚¹å‡»å…·ä½“ç­–ç•¥çš„åˆ é™¤æŒ‰é’®');
        }
        
        // æ ¹æ®IDåˆ é™¤ç­–ç•¥
        async function deleteStrategyById(strategyId) {
            const strategy = strategies.find(s => s.id === strategyId);
            if (!strategy) {
                alert('ç­–ç•¥ä¸å­˜åœ¨');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç­–ç•¥ "${strategy.name}" å—ï¼Ÿ`)) {
                return;
            }
            
            const resultDiv = document.getElementById('strategy-result');
            resultDiv.textContent = `æ­£åœ¨åˆ é™¤ç­–ç•¥ ${strategyId}...`;
            
            try {
                const response = await fetch(`http://localhost:8080/api/v1/ai-control/strategies/${strategyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `ç­–ç•¥åˆ é™¤æˆåŠŸï¼ç­–ç•¥ID: ${strategyId}`;
                    // é‡æ–°åŠ è½½ç­–ç•¥åˆ—è¡¨
                    loadStrategies();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `åˆ é™¤å¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `åˆ é™¤é”™è¯¯: ${error.message}`;
            }
        }
        
        // æµ‹è¯•å‰ç«¯APIè°ƒç”¨
        async function testFrontendAPI() {
            const resultDiv = document.getElementById('frontend-result');
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•å‰ç«¯APIè°ƒç”¨...';
            
            try {
                // æ¨¡æ‹Ÿå‰ç«¯çš„APIè°ƒç”¨æ–¹å¼
                const token = localStorage.getItem('token') || authToken;
                
                const response = await fetch('/api/v1/ai-control/strategies', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `å‰ç«¯APIè°ƒç”¨æˆåŠŸï¼\nç­–ç•¥æ•°é‡: ${result.data?.length || 0}\nå“åº”æ—¶é—´: ${Date.now()}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `å‰ç«¯APIè°ƒç”¨å¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `å‰ç«¯APIè°ƒç”¨é”™è¯¯: ${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç™»å½•
        window.onload = function() {
            testLogin();
        };
    </script>
</body>
</html>
