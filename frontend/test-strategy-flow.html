<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç­–ç•¥æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .test-title {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .success {
            color: #52c41a;
        }
        .error {
            color: #ff4d4f;
        }
        .loading {
            color: #1890ff;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .strategy-card {
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .strategy-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .strategy-details {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¤– AIç­–ç•¥å®Œæ•´æµç¨‹æµ‹è¯•</h1>
        
        <div class="test-section">
            <div class="test-title">ğŸ“‹ ç¬¬1æ­¥ï¼šè·å–ç­–ç•¥åˆ—è¡¨</div>
            <button onclick="testGetStrategies()">è·å–ç­–ç•¥åˆ—è¡¨</button>
            <div id="strategies-list" class="result"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">ğŸŒ¡ï¸ ç¬¬2æ­¥ï¼šè·å–è®¾å¤‡æ•°æ®</div>
            <button onclick="testGetDevices()">è·å–æ¸©åº¦æ¢å¤´</button>
            <button onclick="testGetServers()">è·å–æœåŠ¡å™¨</button>
            <button onclick="testGetBreakers()">è·å–æ–­è·¯å™¨</button>
            <div id="devices-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">â• ç¬¬3æ­¥ï¼šåˆ›å»ºæ–°ç­–ç•¥</div>
            <button onclick="testCreateStrategy()">åˆ›å»ºæµ‹è¯•ç­–ç•¥</button>
            <div id="create-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">ğŸ”„ ç¬¬4æ­¥ï¼šé‡æ–°è·å–ç­–ç•¥åˆ—è¡¨</div>
            <button onclick="testGetStrategiesAfterCreate()">é‡æ–°è·å–ç­–ç•¥åˆ—è¡¨</button>
            <div id="strategies-after" class="result"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">ğŸ“ ç¬¬5æ­¥ï¼šè·å–æ‰§è¡Œå†å²</div>
            <button onclick="testGetHistory()">è·å–æ‰§è¡Œå†å²</button>
            <div id="history-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">ğŸ”— ç¬¬6æ­¥ï¼šæ‰“å¼€AIæ§åˆ¶é¡µé¢</div>
            <button onclick="openAIControlPage()">æ‰“å¼€AIæ§åˆ¶é¡µé¢</button>
            <div id="page-result" class="result"></div>
        </div>
    </div>

    <script>
        let authToken = null;

        // è·å–è®¤è¯token
        async function getAuthToken() {
            if (authToken) return authToken;
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                const data = await response.json();
                if (data.code === 200) {
                    authToken = data.data.token;
                    localStorage.setItem('token', authToken);
                    return authToken;
                }
                throw new Error('ç™»å½•å¤±è´¥');
            } catch (error) {
                console.error('è·å–tokenå¤±è´¥:', error);
                return null;
            }
        }

        // ç¬¬1æ­¥ï¼šè·å–ç­–ç•¥åˆ—è¡¨
        async function testGetStrategies() {
            const resultDiv = document.getElementById('strategies-list');
            resultDiv.innerHTML = '<span class="loading">æ­£åœ¨è·å–ç­–ç•¥åˆ—è¡¨...</span>';
            
            try {
                const token = await getAuthToken();
                if (!token) throw new Error('æ— æ³•è·å–è®¤è¯token');
                
                const response = await fetch('http://localhost:8080/api/v1/ai-control/strategies', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.code === 200) {
                    let html = `<span class="success">âœ… è·å–ç­–ç•¥åˆ—è¡¨æˆåŠŸ (${data.data.length}ä¸ªç­–ç•¥)</span><br><br>`;
                    
                    data.data.forEach((strategy, index) => {
                        html += `
                            <div class="strategy-card">
                                <div class="strategy-name">${index + 1}. ${strategy.name}</div>
                                <div class="strategy-details">
                                    ID: ${strategy.id} | 
                                    çŠ¶æ€: ${strategy.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'} | 
                                    ä¼˜å…ˆçº§: ${strategy.priority} | 
                                    æ¡ä»¶æ•°: ${Array.isArray(strategy.conditions) ? strategy.conditions.length : 'æœªçŸ¥'} | 
                                    åŠ¨ä½œæ•°: ${Array.isArray(strategy.actions) ? strategy.actions.length : 'æœªçŸ¥'}
                                </div>
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<span class="error">âŒ è·å–ç­–ç•¥åˆ—è¡¨å¤±è´¥: ${data.message}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ è·å–ç­–ç•¥åˆ—è¡¨å¤±è´¥: ${error.message}</span>`;
            }
        }

        // ç¬¬2æ­¥ï¼šè·å–è®¾å¤‡æ•°æ®
        async function testGetDevices() {
            const resultDiv = document.getElementById('devices-result');
            resultDiv.innerHTML = '<span class="loading">æ­£åœ¨è·å–è®¾å¤‡æ•°æ®...</span>';
            
            try {
                const token = await getAuthToken();
                if (!token) throw new Error('æ— æ³•è·å–è®¤è¯token');
                
                const [sensorsRes, serversRes, breakersRes] = await Promise.all([
                    fetch('http://localhost:8080/api/v1/sensors', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('http://localhost:8080/api/v1/servers', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('http://localhost:8080/api/v1/breakers', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                
                const [sensorsData, serversData, breakersData] = await Promise.all([
                    sensorsRes.json(),
                    serversRes.json(),
                    breakersRes.json()
                ]);
                
                let html = '<span class="success">âœ… è®¾å¤‡æ•°æ®è·å–æˆåŠŸ</span><br><br>';
                html += `<strong>æ¸©åº¦æ¢å¤´:</strong> ${sensorsData.data?.sensors?.length || 0}ä¸ª<br>`;
                html += `<strong>æœåŠ¡å™¨:</strong> ${serversData.data?.length || 0}ä¸ª<br>`;
                html += `<strong>æ–­è·¯å™¨:</strong> ${breakersData.data?.length || 0}ä¸ª<br><br>`;
                
                // æ˜¾ç¤ºæ¸©åº¦æ¢å¤´è¯¦æƒ…
                if (sensorsData.data?.sensors?.length > 0) {
                    html += '<strong>æ¸©åº¦æ¢å¤´è¯¦æƒ…:</strong><br>';
                    sensorsData.data.sensors.forEach(sensor => {
                        html += `- ${sensor.name} (${sensor.channels?.length || 0}ä¸ªé€šé“)<br>`;
                    });
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ è·å–è®¾å¤‡æ•°æ®å¤±è´¥: ${error.message}</span>`;
            }
        }

        // ç¬¬3æ­¥ï¼šåˆ›å»ºæ–°ç­–ç•¥
        async function testCreateStrategy() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.innerHTML = '<span class="loading">æ­£åœ¨åˆ›å»ºæµ‹è¯•ç­–ç•¥...</span>';
            
            try {
                const token = await getAuthToken();
                if (!token) throw new Error('æ— æ³•è·å–è®¤è¯token');
                
                const testStrategy = {
                    name: 'è‡ªåŠ¨åŒ–æµ‹è¯•ç­–ç•¥-' + Date.now(),
                    description: 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•åˆ›å»ºçš„ç­–ç•¥',
                    conditions: JSON.stringify([{
                        id: '1',
                        type: 'temperature',
                        sensorId: '24-1',
                        sensorName: 'å‰è¿›é£å£',
                        operator: '>',
                        value: '35',
                        unit: 'Â°C'
                    }]),
                    actions: JSON.stringify([{
                        id: '1',
                        type: 'server',
                        targetId: '1',
                        targetName: 'æµ‹è¯•æœåŠ¡å™¨',
                        operation: 'shutdown'
                    }]),
                    status: 'å¯ç”¨',
                    priority: 'é«˜'
                };
                
                const response = await fetch('http://localhost:8080/api/v1/ai-control/strategies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(testStrategy)
                });
                const data = await response.json();
                
                if (data.code === 200 || data.code === 201) {
                    resultDiv.innerHTML = `
                        <span class="success">âœ… ç­–ç•¥åˆ›å»ºæˆåŠŸ</span><br><br>
                        <strong>ç­–ç•¥ID:</strong> ${data.data.id}<br>
                        <strong>ç­–ç•¥åç§°:</strong> ${data.data.name}<br>
                        <strong>åˆ›å»ºæ—¶é—´:</strong> ${data.data.created_at}<br><br>
                        <strong>å®Œæ•´å“åº”:</strong><br>
                        ${JSON.stringify(data, null, 2)}
                    `;
                } else {
                    resultDiv.innerHTML = `<span class="error">âŒ ç­–ç•¥åˆ›å»ºå¤±è´¥: ${data.message}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ ç­–ç•¥åˆ›å»ºå¤±è´¥: ${error.message}</span>`;
            }
        }

        // ç¬¬4æ­¥ï¼šé‡æ–°è·å–ç­–ç•¥åˆ—è¡¨
        async function testGetStrategiesAfterCreate() {
            await testGetStrategies();
            const result = document.getElementById('strategies-list').innerHTML;
            document.getElementById('strategies-after').innerHTML = result;
        }

        // ç¬¬5æ­¥ï¼šè·å–æ‰§è¡Œå†å²
        async function testGetHistory() {
            const resultDiv = document.getElementById('history-result');
            resultDiv.innerHTML = '<span class="loading">æ­£åœ¨è·å–æ‰§è¡Œå†å²...</span>';
            
            try {
                const token = await getAuthToken();
                if (!token) throw new Error('æ— æ³•è·å–è®¤è¯token');
                
                const response = await fetch('http://localhost:8080/api/v1/ai-control/executions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.code === 200) {
                    const items = data.data.items || [];
                    let html = `<span class="success">âœ… è·å–æ‰§è¡Œå†å²æˆåŠŸ (${items.length}æ¡è®°å½•)</span><br><br>`;
                    
                    items.forEach((record, index) => {
                        html += `
                            <div class="strategy-card">
                                <div class="strategy-name">${index + 1}. ${record.strategy_name}</div>
                                <div class="strategy-details">
                                    çŠ¶æ€: ${record.status} | 
                                    è§¦å‘åŸå› : ${record.trigger_reason} | 
                                    æ‰§è¡Œæ—¶é—´: ${record.start_time} | 
                                    æŒç»­æ—¶é—´: ${record.duration}s
                                </div>
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<span class="error">âŒ è·å–æ‰§è¡Œå†å²å¤±è´¥: ${data.message}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ è·å–æ‰§è¡Œå†å²å¤±è´¥: ${error.message}</span>`;
            }
        }

        // ç¬¬6æ­¥ï¼šæ‰“å¼€AIæ§åˆ¶é¡µé¢
        function openAIControlPage() {
            window.open('http://localhost:3005/ai-control', '_blank');
            document.getElementById('page-result').innerHTML = '<span class="success">âœ… AIæ§åˆ¶é¡µé¢å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€</span>';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–ç­–ç•¥åˆ—è¡¨
        window.onload = function() {
            testGetStrategies();
        };
    </script>
</body>
</html>
